# Modified Mutation Gate

1. Dynamically resolve the SSN by putting hardware breakpoint at sysenter instruction and calling the api with invalid arguments (probably NULL)
2. Use MutationGate technique

#### set Hardware Breakpoint

```c

VOID SetHWBP(LPVOID address, BOOL setBP) {
    
    CONTEXT context = { 0 };
    context.ContextFlags = CONTEXT_DEBUG_REGISTERS;
    GetThreadContext(GetCurrentThread(), &context);

    if (setBP) {
        context.Dr0 = (DWORD64)address;
        context.Dr7 |= (1 << 0);
        context.Dr7 &= ~(1 << 16);
        context.Dr7 &= ~(1 << 17);
    }
    else {
        context.Dr0 = 0;
        context.Dr7 &= ~(1 << 0);
    }

    context.ContextFlags = CONTEXT_DEBUG_REGISTERS;
    SetThreadContext(GetCurrentThread(), &context);
    return;
}

```


#### Set Handler

```c

LONG WINAPI recover_eax_handler(EXCEPTION_POINTERS* ExceptionInfo) {
    if (ExceptionInfo->ExceptionRecord->ExceptionCode == STATUS_SINGLE_STEP) {
        if (ExceptionInfo->ContextRecord->Dr0 == ExceptionInfo->ContextRecord->Rip) {
            SSN = ExceptionInfo->ContextRecord->Rax;
            //printf("[+] Got SSN: %x\n", SSN);
            SetHWBP((LPVOID)ExceptionInfo->ContextRecord->Rip, FALSE);
        }
        ExceptionInfo->ContextRecord->EFlags |= (1 << 16);
        return EXCEPTION_CONTINUE_EXECUTION;
    }
    return EXCEPTION_CONTINUE_SEARCH;
}

```

#### Recover SSN

```c
SetHWBP((LPVOID)((DWORD64)NtAllocateVirtualMemory + 0x12), TRUE);
AddVectoredExceptionHandler(1, recover_eax_handler);
NtAllocateVirtualMemory(NULL, NULL, NULL, NULL, NULL, NULL);
```

Now any technique MutationGate/Indirect Syscall can be used after recovering SSN

Demo
<video src="Mutation_Gate_PEB.mp4" controls="controls" style="max-width: 730px;">
</video>

Demo:

![Demo](Mutation_Gate_PEB.mp4)